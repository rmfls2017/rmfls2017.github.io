---
layout: post
title: "하삽 (하루 삽질기) - 데이터가 삭제된 날"
author: "rmfls2017"
tags: [php, laravel, aws, ec2, ebs]
image: 6ebb2cf8ed8a3f6cdebe2f6aedc640e6.jpg
---

본 포스터에서는 어느 금요일 퇴근하기 전 발생했던 일의 행적을 따라 적은 글이다.

# 문제발생 두 달 전

사내에서 개발중인 플랫폼이 있었다. 진행중인 플랫폼은 라라벨을 통해서 구축하고 있었고 이전의 플랫폼은 마젠토를 사용하고 있었다.

마젠토를 통해서 개발자가 새로운 기능이나 다른 요구사항을 직접적으로 구현할 수 없었고 이 때문에 관리가 되지 않고 있었다.

하여 마젠토에서 가지고 있는 구조를 마이그레이션 해야했고 데이터의 구조부터해서 이미지 파일, 필요기능을 가져와야했다.

그 중 문제는 이미지 파일에서 나왔는데 마젠토에서 가지는 이미지 파일 저장 경로대로 마이그레이션하기가 상당히 까다로웠다.

그리하여 이미지 경로를 통으로 옮겨서 라라벨을 통해 저장하는 경로에 통째로 넣어두었다.

그리고 이미지 경로를 참조하는 데이터 테이블을 수정하여 바꿔주고 AWS CloudFront 에서 들어오는 경로를 찾아갈 수 있도록 했다.

# 문제발생 한 달 전

특정 데이터를 삭제하기 위해서 이미지를 같이 삭제해야하는 이슈가 있었다.

서비스 오픈 후에 저장된 이미지를 삭제한다면 아무 문제 없이 가능했지만 마이그레이션한 이미지가 문제였다.

데이터 마이그레이션을 할 때 경로가 잘못 저장되어있음을 인지하고 이에 대한 토의가 이어졌다.

그리하여 기존에 파일은 삭제하지 않는 방향으로 갔다.

하지만 여전히 데이터를 삭제해야하는 이슈가 있었다.

# 문제발생 일주일 전

삭제에 대한 이슈가 다시 한번 나왔다.

데이터를 관리하기 힘들다며 이제 사용하지 않는 (관리하지 않는 데이터) 것은 삭제했으면 한다고 했다.

그리하여 삭제하고자 하는 데이터와 연관된 이미지를 삭제할 수 있도록 했다.

마이그레이션된 데이터의 경로를 정상적으로 업데이트하고 이미지를 삭제할 수 있도록 기능을 만들었다.

# 문제발생 하루 전

기능을 완료하고 실서버에 배포하였다.

데이터 삭제가 잘 된다. 파일 삭제가 잘 된다.

하지만 permission 문제로 인해 이미지의 부모 경로까지 있는 디렉토리를 삭제하지 못한다.

이로인해 로그가 계속 찍혔다.

# 문제발생 한 시간 전

이 로그를 보고 퍼미션을 바꿨다.

부모 경로에 있는 디렉토리를 삭제할 수 있도록.

# 문제발생 일 분 전

삭제 기능 클릭

# 문제발생

![금기어](/assets/img/6ebb2cf8ed8a3f6cdebe2f6aedc640e6.jpg)
출처: https://www.teamblind.com/kr/post/개발자-사무실에서-금지어-🥱-JSBDANCe

## 어...?

내 뒤에서 짧지만 아주 강렬한 말이 튀어나왔다

순간 뭔가 일이 터졌다는 걸 깨달았다.

동시에 내가 꿈꾸던 금요일도 사려졌다.

정학히 시간도 기억난다. 금요일 18시 19분.

퇴근해야하는데 일이 벌어졌다.

# 문제인지

삭제가 오래걸렸다고하여 서버에 확인해보니 마이그레이션된 이미지 경로에 있는 이미지가 통째로 사라졌다.

관련 없는 파일들도 다 삭제가 되었다.

# 해결방안 모색

그 때 부터 시간 싸움이였다.

아래의 글에서 보여지는 시간은 문제 해결을 위해 취한 행동을 기록한 시간대이다

## 문제원인

원인 파악 인원과 사고 처리 인원이 각 역할을 수행하기로 했다.

작성자는 사고처리 인원으로 역할을 수행한다.

왜 그런일이 발생했을까? (18시 21분)

데이터를 삭제하는 과정에서 이미지를 같이 삭제하는데 이 이미지 관리하는 라이브러리가 따로 있었는데, official 로 지원해주는 툴이 아닌 third party 라이브러리였다. (18시 34분)

그로 인해 삭제 기능을 구현했음에도 불구하고 이 라이브러리의 정확한 구동방식에 대해서 숙지하지 못했던 이유가 컸다.

코드를 보니 모든 이미지를 삭제할 때 상위에 있는 디렉토리까지 같이 삭제하는 역할을 수행중이였다. (17시 13분)

```php
$imageHandler->removeAllFiles()
```

## 과정

그렇다면, 이미 다 날라간 데이터를 어떻게 복구해야할까?

이미지를 옮기는 과정을 맡았던 개발자는 이미 나간 상태여서 담당자에게 헬프를 칠 수 없었다.

문제가 발생하여도 그 중 다행인것은 모든 이미지가 날라간 것이 아닌 점, CloudFront 에 이미 남아있는 캐시가 있다는 것 (18시 31분)

글 시작부터 얘기했지만 과거의 이미지를 통째로 복사해온 것이 한 가지 대책으로 떠올랐다. (18시 33분)

이 전에 이미지만을 떠 와서 복사하나면 가능하지 않을까?

총 이미지 용량을 확인해보니 25G 정도였다. (4G, 5G 통신 속도가 아닌 용량 25G!!) (18시 35분)

일단 로컬에다가 다운로드 받을 수 있게 먼저 작업을 하고 서버에 당장 복사한다는 건 불가능하다.

또 다른 방안, 이 전 인프라를 정리하면서 백업해둔 디스크가 있는데 이 디스크를 활용해보자 

디스크를 현재 기준이 되는 컴퓨팅 인스턴스에 마운트하여 심볼릭 링크를 걸어서 유지하자 (18시 47분)

여러대의 서버에서 하나의 경로를 바라보고있었기에 하나의 인스턴스에 거는 것은 괜찮지만 그 외의 인스턴스에서는 참조 불가능 (18시 54분)

마지막, 마운트한 디스크에서 삭제한 경로대로 이미지를 그대로 복사하자 (19시 15분)

```shell
$ rsync -avx ORIGIN_PATH TARGET_PATH
```

제대로 확인해보고자 들어갔더니 1 depth 를 더 들어가서 저장했다. (19시 41분)

그렇게 디렉토리 상위 디렉토리로 이동 (19시 43분)

마지막으로 수행헀던 과정이 속도가 빠르고 그나마 제일 안전하게 진행되었다.

# 결과

어찌저찌해서 이미지를 그대로 옮겨놓았고 약간의 패닉과 그 안에서도 정리를 진행해 보았다.

다시 생각해보면 원인은 라이브러리의 이해도에 있었다. 

단순히 기능하나를 수행하지만 그 안에서 일어나는 역할을 파악하지 못한채로 하다보니 이런 일이 나왔지 않았을까

이러한 일을 통해서 본인이 느꼈던 점 몇 가지를 꼽아보았다

```
1. 기능 테스트의 필ㅛ
2. 에러가 발생하고 있었음에도 파악하지 못했던 점
3. 미래에 일어날 일에 대한 대안책 미비 (잘못된 개발이였지만 방치하고 있었음)
4. 무분별한 라이브러리 사용
...
...
...
...
5. 금요일에 배포 및 작업 진행
```

이번 일을 계기로 너무 뼈져리게 느꼈다.

누구나 실수할 수 있고 어디에서도 실수를 할 수 있다. 실수가 발생했을 때 어떻게 처리를 하느냐가 그 사람의 센스와 기술이 좋은지 판단할 수 있지 않을까?

좋은 회사로 발 돋움하기 위해서는 위의 내용뿐만 아니라 스스로 찾고 취약점을 해결하는 것이 회사로써의 발전이 아닐까?

물론 나부터 잘 해야지 회사가 잘될텐데...
